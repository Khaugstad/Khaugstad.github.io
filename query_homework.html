<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title> Query Homework </title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.21/"> </script>
    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        #optionsDiv {
            background-color: rgb(255, 0, 0);
            color: white;
            padding: 10px;
            width: 350px;
        }

        .esri-popup .esri-popup-header .esri-title {
            font-size: 18px;
            font-weight: bolder;
        }

        .esri-popup .esri-popup-body .esri-popup-content {
            font-size: 14px;
        }
    </style>
    <script>
        require(["esri/Map", "esri/views/MapView", "esri/layers/TileLayer", "esri/layers/FeatureLayer", "esri/widgets/BasemapGallery", "esri/layers/GraphicsLayer",
            "esri/tasks/QueryTask", "esri/tasks/support/Query",
            "dojo/_base/array", "dojo/dom", "dojo/on",
            "dojo/domReady!"],
            function (Map, MapView, TileLayer, FeatureLayer, BasemapGallery, GraphicsLayer, QueryTask, Query,
                arrayUtils, dom, on) {

                var BedrockLayer = new FeatureLayer({
                    url: "https://services.arcgis.com/V6ZHFr6zdgNZuVG0/ArcGIS/rest/services/Minnesota_Bedrock_Outcrop_gdb/FeatureServer/0"
                });

                var TransportationLayer = new TileLayer({
                    url: "https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer"
                });
                var map = new Map({
                    basemap: "oceans",
                    layers: [TransportationLayer, BedrockLayer]
                });
                var view = new MapView({
                    container: "viewDiv",
                    map: map,
                    zoom: 6,
                    center: [-94.5, 46]
                });

                view.when(function () {
                    view.ui.add("optionsDiv", "bottom-right");
                    on(dom.byId("doBtn"), "click", doQuery);
                });


                var rockTypeValue = dom.byId("rockTypeSelect");

                var areaSelect = dom.byId("areaSelect");
                var expressionSign = dom.byId("signSelect");
                var areaValue = dom.byId("areaValSelect");


                function doQuery() {
                    //BedrockLayer.removeAll();
                    params.where = /*rockTypeValue.value + areaSelect.value*/ "SHAPE__Area" + expressionSign.value + areaValue.value + "AND rk_name1 = " + rockTypeValue.value;
                    qTask.execute(params).then(getResults).catch(promiseRejected);
                }

                function getResults(response) {
                  console.log(response);
                    var popResults = arrayUtils.map(
                        response.features,
                        function (feature) {
                            feature.popupTemplate = popupTemplate;
                            return feature;
                        }
                    );
                    resultsLayer.addMany(popResults);
                    view.goTo(popResults).then(function () {
                        view.popup.open({
                            features: popResults,
                            featureMenuOpen: true,
                            updateLocationEnabled: true
                        });
                    });
                    dom.byId("printResults").innerHTML = popResults.length + " results found!";
                };

                function promiseRejected(error) {
                    console.error("Promise rejected: ", error.message, " Parameter values: ", expressionSign.value,
                        areaValue.value, rockTypeValue.value);
                }

                var popUrl = "https://services.arcgis.com/V6ZHFr6zdgNZuVG0/ArcGIS/rest/services/Minnesota_Bedrock_Outcrop_gdb/FeatureServer/0";
                var popupTemplate = {
                    title: "{reference}",
                    fieldInfos: [
                        /*{
                            fieldName: "SHAPE__Area",
                            label: "shapeArea",
                            format: {
                                places: 0,
                                digitSeperator: true
                            }
                        }*/
                    ],
                    content: "<b>Rock Type:" + "</b> {rk_name1} " + "<br><b>Area:</b> {SHAPE__Area}" + "<br><b>Latitude:</b> \
                    {latitude} " + " < br > <b>Longitude:</b> {longitude} "
                };
                var resultsLayer = new GraphicsLayer();
                var qTask = new QueryTask({ url: popUrl });
                var params = new Query({ returnGeometry: true, outFields: ["*"] });

            });

    </script>
</head>

<body>
    <div id="viewDiv"></div>
    <div class="esri-widget" id="optionsDiv">
        <h2>Bedrock Outcrops in Minnesota</h2>
        <p>Rock Type:
        <select class="esri-widget" id="rockTypeSelect">
            <option value="&#39;Granite&#39;">Granite</option>
            <option value="&#39;Quartzite&#39;">Quartzite</option>
            <option value="&#39;Schist&#39;">Schist</option>
            <option value="&#39;Basalt&#39;">Basalt</option>
            <option value="&#39;Unknown&#39;">Unkown</option>
        </select>
      </p>
        <br>
        <select class="esri-widget" id="areaSelect">
          <option value="Area">Area (m)</option>
          <option value="Area">Area (ft)</option>
        </select>
        <select class="esri-widget" id="signSelect">
            <option value="&gt;">is greater than</option>
            <option value="&lt;">is less than</option>
        </select>
        <select class="esri-widget" id="areaValSelect">
            <option value="1000">1000</option>
            <option value="2000">2000</option>
            <option value="5000">5000</option>
            <option value="10000">10,000</option>
            <option value="20000">20,000</option>
            <option value="50000">50,000</option>
            <option value="10000">10,000</option>
            <option value="20000">20,000</option>
            <option value="50000">50,000</option>
            <option value="100000">100,000</option>
            <option value="200000">200,000</option>
            <option value="500000">500,000</option>
            <option value="1000000">1,000,000</option>
        </select>
        <br>
        <br>
        <button class="esri-widget" id="doBtn">Do Query</button>
        <br>
        <p><span id="printResults"></span></p>
        <label for="demo-select">Open demo:</label>
        <select id="demo-select" aria-label="Open demo in new tab">
            <option value="">-- Select a demo --</option>

            <option value="https://Khaugstad.github.io/simple_mapping.html">simple_mapping</option>
            <option value="https://Khaugstad.github.io/tile_layer.html">Tile layer</option>
            <option value="https://Khaugstad.github.io/dynamic_layers.html">dynamic_layers</option>
            <option value="https://Khaugstad.github.io/on_event.html">on_event</option>
            <option value="https://Khaugstad.github.io/basemap_gallery.html">basemap_gallery</option>
            <option value="https://Khaugstad.github.io/query_task.html">query_task</option>

        </select>

        <script>
            document.getElementById('demo-select').addEventListener('change', function () {
                const url = this.value;
                if (!url) return;
                // open in a new tab and avoid keeping a reference to the opener
                const win = window.open('', '_blank');
                if (win) {
                    try { win.opener = null; } catch (e) { }
                    win.location = url;
                } else {
                    // fallback if popup blocked: navigate in current tab (rare)
                    window.location.href = url;
                }
                // reset selection
                this.selectedIndex = 0;
            });
        </script>
        
        </div>
    </div>
    <div id="copyright">
        <script>
            // tell code to add a date to the copyright.
            var today = new Date();
            // tell code to add the full year (this year) to the copyright.
            var year = today.getFullYear();
            // tell the code to copyright with symbol and year and is formatted/ written.
            document.writeln("Copyright &copy; " + year);
        </script>
    </div>


</body>

</html>
